name: CI Validation

on:
  pull_request:
    branches: [main]
  workflow_call: # Allow other workflows to call this
  workflow_dispatch: # Manual trigger

permissions:
  contents: read

jobs:
  hadolint:
    name: Dockerfile Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Run hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile

  pre-commit:
    name: Pre-commit Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          # Read Python version from .python-version file
          python-version-file: ".python-version"
          # Cache pip dependencies (pre-commit package itself)
          cache: "pip"
          cache-dependency-path: "requirements-dev.txt"

      - name: Cache pre-commit hooks
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cache/pre-commit/
          # Key includes Python version and config hash for proper invalidation
          key: pre-commit-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ steps.setup-python.outputs.python-version }}-

      - name: Install pre-commit
        run: |
          pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run pre-commit hooks
        run: pre-commit run --all-files --show-diff-on-failure

  ci-summary:
    name: Validation Results
    runs-on: ubuntu-latest
    needs: [hadolint, pre-commit]
    if: always()

    steps:
      - name: CI Status
        run: |
          echo "## üß™ CI Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Hadolint | ${{ needs.hadolint.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-commit | ${{ needs.pre-commit.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.hadolint.result }}" == "success" && "${{ needs.pre-commit.result }}" == "success" ]]; then
            echo "‚úÖ All CI checks passed!"
          else
            echo "‚ùå CI checks failed - please fix before proceeding"
            exit 1
          fi
