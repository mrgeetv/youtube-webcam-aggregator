name: Build & Test

on:
  push:
    branches:
      - "build/**" # Build testing branches only (NOT main)
  workflow_dispatch: # Manual trigger

permissions:
  contents: read

jobs:
  # Ensure CI passes first
  ci-validation:
    name: CI Validation
    uses: ./.github/workflows/ci.yml

  docker-build:
    name: Docker Build & Push
    needs: ci-validation
    uses: ./.github/workflows/docker-build.yml
    with:
      tags: |
        ghcr.io/${{ github.repository }}:${{ github.ref_name }}-${{ github.sha }}
        ghcr.io/${{ github.repository }}:${{ github.ref_name }}-latest
    secrets: inherit

  build-summary:
    name: Build Results
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: always()

    steps:
      - name: Build Status
        run: |
          echo "## üèóÔ∏è Build Results" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker-build.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Images pushed to registry for testing!**" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.docker-build.result }}" == "success" ]]; then
            echo "‚úÖ Build completed successfully!"
          else
            echo "‚ùå Build failed"
            exit 1
          fi
